name: PR Failure Notifications

on:
  workflow_run:
    workflows: ['PR']
    types:
      - completed

permissions:
  actions: read
  issues: write
  pull-requests: write

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse CODEOWNERS
        id: codeowners
        run: |
          fallback=""
          if [ -f ".github/CODEOWNERS" ]; then
            fallback=$(grep -v '^\s*#' .github/CODEOWNERS | grep '^\s*\*' | tail -n 1 | awk '{$1=""; print $0}' | xargs)
          fi
          echo "owners=${fallback}" >> "$GITHUB_OUTPUT"

      - name: Create or update failure issue
        uses: actions/github-script@v7
        env:
          OWNERS: ${{ steps.codeowners.outputs.owners }}
        with:
          script: |
            const run = context.payload.workflow_run;
            const runId = run.id;
            const prNumber = run.pull_requests && run.pull_requests[0] ? run.pull_requests[0].number : null;
            if (!prNumber) {
              core.info('No pull request associated with this workflow run. Skipping notification.');
              return;
            }

            const jobsResp = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
              per_page: 100
            });

            const failingJobs = jobsResp.data.jobs
              .filter(job => job.conclusion && job.conclusion !== 'success')
              .map(job => `${job.name} (${job.conclusion})`);

            const title = `⚠️ PR Workflow Failure #${prNumber}`;
            const bodyLines = [
              `Workflow **${run.name}** for PR #${prNumber} finished with status \`${run.conclusion}\`.`,
              '',
              failingJobs.length ? `**Failing jobs:** ${failingJobs.join(', ')}` : 'No specific job failures were reported.',
              `[View run](${run.html_url})`
            ];

            const assignees = (process.env.OWNERS || '')
              .split(/\s+/)
              .map((value) => value.replace(/^@/, ''))
              .filter(Boolean);

            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} "${title}" in:title state:open`
            });

            if (search.data.items.length > 0) {
              const issueNumber = search.data.items[0].number;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: bodyLines.join('\n')
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: bodyLines.join('\n'),
                assignees
              });
            }

