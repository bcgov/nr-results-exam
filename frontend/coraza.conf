# Coraza WAF Configuration
# Basic WAF configuration with security rules

# Enable rules engine
SecRuleEngine On

# Request body handling
# Request body limits:
# - File uploads: ~12.5MB (SecRequestBodyLimit 13107200)
# - Non-file payloads (JSON, form data): 512KB (SecRequestBodyNoFilesLimit 524288)
# Adjust based on your application's needs (file uploads, API payloads, etc.)
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 524288

# Response body handling
# Disabled since no response body inspection rules are configured
# Enable if you plan to add response body inspection rules in the future
# When enabled, configure SecResponseBodyMimeType and SecResponseBodyLimit
SecResponseBodyAccess Off

# File upload handling
# Directories are created in the Dockerfile with OpenShift-compatible permissions (777)
# In production, consider using persistent volumes with restricted permissions
SecTmpDir /tmp/coraza/
SecDataDir /tmp/coraza/

# Logging
# RelevantOnly: Only logs transactions that trigger rules or cause errors
# This reduces log volume but means allowed requests won't have audit trails
# For full audit trails (compliance), use SecAuditEngine On with log rotation
SecAuditEngine RelevantOnly
# Audit log parts: A (header), B (request headers), I (request body alt), E (response body), F (response headers), H (trailer), Z (boundary)
# Parts D and J are reserved and not used
SecAuditLogParts ABIEFHZ
SecAuditLogType Serial
SecAuditLog /dev/stdout

# Debug log (disabled in production with level 0)
SecDebugLog /dev/stdout
SecDebugLogLevel 0

# Generic attack detection using Coraza's built-in operators
# These rules use Coraza's optimized built-in detection operators for comprehensive coverage
SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectSQLi" \
    "id:1001,phase:2,deny,log,msg:'SQL Injection Attack Detected',status:403"

SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectXSS" \
    "id:1002,phase:2,deny,log,msg:'XSS Attack Detected',status:403"

# Block common security scanners by User-Agent with word boundaries
# Note: Burp Suite is excluded to allow authorized security testing
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)\b(nikto|sqlmap|nmap|masscan|nessus|openvas|acunetix)\b" \
    "id:1003,phase:1,deny,log,msg:'Known Security Scanner Detected',status:403"

# Block access to sensitive paths - anchored to beginning of URI
# This intentionally blocks common paths targeted by attackers (/.env, /.git, /admin, etc.)
# The pattern matches both /path and /path/ for comprehensive protection
# If your application legitimately uses any of these paths, whitelist them using:
#   SecRuleRemoveById 1004
#   SecRule REQUEST_URI "@rx ^/your-legitimate-path(/|$)" "id:1004a,phase:1,pass"
#   SecRule REQUEST_URI "@rx ^/(other|paths|to|block)(/|$)" "id:1004b,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"
# Or modify this rule to exclude specific paths from the block list
SecRule REQUEST_URI "@rx ^/(admin|config|backup|tmp|logs|wp-admin|\.env|\.git|\.htaccess|\.htpasswd|\.ssh|\.aws|web\.config)(/|$)" \
    "id:1004,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"

# Common attack patterns - SQL Injection (enhanced with comments and procedure calls)
# Uses word boundaries and whitespace requirements to reduce false positives
# SQL comment patterns: --(\s|$) matches comments with whitespace or end of string
# Note: SQL block comment detection removed to prevent ReDoS risk; rely on @detectSQLi (rule 1001) for safe detection
# Note: Rule ID 1006 is intentionally skipped/reserved for future use or compatibility with other rule sets
SecRule ARGS "@rx (?i)(union\s+select|insert\s+into|delete\s+from|drop\s+table|update\s+set|exec\s*\(|execute\s*\(|\bsp_|\bxp_|--(\s|$))" \
    "id:1005,phase:2,deny,log,msg:'SQL Injection Pattern Detected',status:403"

# Path traversal protection - comprehensive encoding variations
SecRule REQUEST_URI|ARGS "@rx (?i)(\.\.(/|\\|%2f|%5c)|(%2e%2e|%252e%252e)(/|\\|%2f|%5c))" \
    "id:1007,phase:2,deny,log,msg:'Path Traversal Attempt Detected',status:403"

# Null byte injection
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@rx \x00" \
    "id:1008,phase:2,deny,log,msg:'Null Byte Injection Detected',status:403"

# Note on rule redundancy:
# Rules 1001/1002 use Coraza's built-in @detectSQLi/@detectXSS operators for comprehensive detection.
# Rules 1005, 1007, and 1008 use custom regex patterns for specific attack vectors.
# This defense-in-depth approach provides multiple layers of protection:
# - Built-in operators catch a wide range of attack patterns
# - Custom rules catch specific patterns that may bypass generic detection
# - Both layers together reduce false negatives while maintaining performance
