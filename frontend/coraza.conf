# Coraza WAF Configuration
# Basic WAF configuration with security rules
# Optimized for performance: excludes static files and health checks

# Enable rules engine
SecRuleEngine On

# Performance optimization: Skip WAF processing for static files and health checks
# These paths are safe and don't need WAF inspection
SecRule REQUEST_URI "@rx ^/(health|favicon\.ico|.*\.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|map))$" \
    "id:999,phase:1,pass,ctl:ruleEngine=Off"

# Request body handling
# Request body limits:
# - File uploads: ~12.5MB (SecRequestBodyLimit 13107200)
# - Non-file payloads (JSON, form data): 512KB (SecRequestBodyNoFilesLimit 524288)
# Adjust based on your application's needs (file uploads, API payloads, etc.)
# Note: REQUEST_BODY processing is optimized - only enabled for POST/PUT/PATCH requests
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 524288

# Response body handling
# Disabled since no response body inspection rules are configured
# Enable if you plan to add response body inspection rules in the future
# When enabled, configure SecResponseBodyMimeType and SecResponseBodyLimit
SecResponseBodyAccess Off

# File upload handling
# Directories are created in the Dockerfile with OpenShift-compatible permissions (777)
# In production, consider using persistent volumes with restricted permissions
SecTmpDir /tmp/coraza/
SecDataDir /tmp/coraza/

# Logging
# RelevantOnly: Only logs transactions that trigger rules or cause errors
# This reduces log volume but means allowed requests won't have audit trails
# For full audit trails (compliance), use SecAuditEngine On with log rotation
SecAuditEngine RelevantOnly
# Audit log parts: A (header), B (request headers), I (request body alt), F (response headers), H (trailer), Z (boundary)
# Parts D and J are reserved and not used
# Part E (response body) is excluded since SecResponseBodyAccess is Off
SecAuditLogParts ABIFHZ
SecAuditLogType Serial
SecAuditLog /dev/stdout

# Debug log (disabled in production with level 0)
SecDebugLog /dev/stdout
SecDebugLogLevel 0

# Performance: Only process request body for POST/PUT/PATCH requests
# This avoids overhead on GET requests which don't have bodies
SecRule REQUEST_METHOD "!@rx ^(POST|PUT|PATCH)$" \
    "id:1000,phase:1,pass,ctl:requestBodyAccess=Off"

# Generic attack detection using Coraza's built-in operators
# These rules use Coraza's optimized built-in detection operators for comprehensive coverage
# Phase 2 rules only run when request body access is enabled (POST/PUT/PATCH)
SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectSQLi" \
    "id:1001,phase:2,deny,log,msg:'SQL Injection Attack Detected',status:403"

SecRule REQUEST_HEADERS|ARGS|ARGS_NAMES "@detectXSS" \
    "id:1002,phase:2,deny,log,msg:'XSS Attack Detected',status:403"

# Additional REQUEST_BODY inspection only for POST/PUT/PATCH requests
# These rules only execute when REQUEST_BODY exists (POST/PUT/PATCH)
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
    "id:1010,phase:2,pass,chain"
SecRule REQUEST_BODY "@detectSQLi" \
    "deny,log,msg:'SQL Injection Attack Detected in Request Body',status:403"

SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
    "id:1011,phase:2,pass,chain"
SecRule REQUEST_BODY "@detectXSS" \
    "deny,log,msg:'XSS Attack Detected in Request Body',status:403"

# Block common security scanners by User-Agent with word boundaries
# Note: Burp Suite is excluded to allow authorized security testing
# Phase 1 rule for fast rejection without body processing
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)\b(nikto|sqlmap|nmap|masscan|nessus|openvas|acunetix)\b" \
    "id:1003,phase:1,deny,log,msg:'Known Security Scanner Detected',status:403"

# Block access to sensitive paths - anchored to beginning of URI
# This intentionally blocks common paths targeted by attackers (/.env, /.git, /admin, etc.)
# The pattern matches both /path and /path/ for comprehensive protection
# Phase 1 rule for fast rejection without body processing
# If your application legitimately uses any of these paths, whitelist them using:
#   SecRuleRemoveById 1004
#   SecRule REQUEST_URI "@rx ^/your-legitimate-path(/|$)" "id:1004a,phase:1,pass"
#   SecRule REQUEST_URI "@rx ^/(other|paths|to|block)(/|$)" "id:1004b,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"
# Or modify this rule to exclude specific paths from the block list
SecRule REQUEST_URI "@rx ^/(admin|config|backup|tmp|logs|wp-admin|\.env|\.git|\.htaccess|\.htpasswd|\.ssh|\.aws|web\.config)(/|$)" \
    "id:1004,phase:1,deny,log,msg:'Access to sensitive path blocked',status:403"

# Common attack patterns - SQL Injection (enhanced with comments and procedure calls)
# Uses word boundaries and whitespace requirements to reduce false positives
# SQL line comment patterns: --(\s|$) matches comments with whitespace or end of string
# Note: SQL block comment detection removed to prevent ReDoS risk; rely on @detectSQLi (rule 1001) for safe detection
# Note: This rule is redundant with rule 1001 (@detectSQLi) but kept for specific pattern matching
SecRule ARGS "@rx (?i)(union\s+select|insert\s+into|delete\s+from|drop\s+table|update\s+set|exec\s*\(|execute\s*\(|\bsp_|\bxp_|--(\s|$))" \
    "id:1005,phase:2,deny,log,msg:'SQL Injection Pattern Detected',status:403"

# Path traversal protection - comprehensive encoding variations
# Check URI in phase 1 for fast rejection, ARGS in phase 2
SecRule REQUEST_URI "@rx (?i)(\.\.(/|\\|%2f|%5c)|(%2e%2e|%252e%252e)(/|\\|%2f|%5c))" \
    "id:1007,phase:1,deny,log,msg:'Path Traversal Attempt Detected in URI',status:403"
SecRule ARGS "@rx (?i)(\.\.(/|\\|%2f|%5c)|(%2e%2e|%252e%252e)(/|\\|%2f|%5c))" \
    "id:1009,phase:2,deny,log,msg:'Path Traversal Attempt Detected in Arguments',status:403"

# Null byte injection
# Check headers and URI first (phase 1) for faster rejection
SecRule REQUEST_URI|REQUEST_HEADERS "@rx \x00" \
    "id:1008,phase:1,deny,log,msg:'Null Byte Injection Detected',status:403"
# Additional check for ARGS in phase 2
SecRule ARGS "@rx \x00" \
    "id:1012,phase:2,deny,log,msg:'Null Byte Injection Detected in Arguments',status:403"
# REQUEST_BODY check only for POST/PUT/PATCH
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
    "id:1013,phase:2,pass,chain"
SecRule REQUEST_BODY "@rx \x00" \
    "deny,log,msg:'Null Byte Injection Detected in Request Body',status:403"

# Note on rule redundancy:
# Rules 1001/1002 use Coraza's built-in @detectSQLi/@detectXSS operators for comprehensive detection.
# Rules 1005, 1007, and 1008 use custom regex patterns for specific attack vectors.
# This defense-in-depth approach provides multiple layers of protection:
# - Built-in operators catch a wide range of attack patterns
# - Custom rules catch specific patterns that may bypass generic detection
# - Both layers together reduce false negatives while maintaining performance
