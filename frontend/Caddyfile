{
	auto_https off
	admin off
}

:3000 {
	root * /srv

	encode gzip

	log {
		output stdout
		format console {
			time_format iso8601
			level_format color
		}
		level {$LOG_LEVEL}
	}

	header {
		# Security headers
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1;mode=block"
		Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000"
		Content-Security-Policy "base-uri 'self';
			connect-src 'self' {$VITE_BACKEND_URL} https://*.gov.bc.ca https://*.amazoncognito.com https://*.cloudfront.net https://cognito-idp.ca-central-1.amazonaws.com;
			default-src 'self';
			font-src 'self';
			form-action 'self';
			frame-ancestors 'self';
			frame-src 'self' https://*.gov.bc.ca;
			img-src 'self' http://www.w3.org/ data:;
			manifest-src 'self';
			media-src 'self';
			object-src 'none';
			script-src 'self' 'sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe' 'sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE' 'sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ' https://cdn.jsdelivr.net;
			style-src 'self' 'sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ' https://cdn.jsdelivr.net;
			worker-src 'none';"
		Referrer-Policy "same-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=(), vibrate=(), ambient-light-sensor=(), accelerometer=(), autoplay=(), encrypted-media=(), picture-in-picture=()"
		Cross-Origin-Opener-Policy "same-origin-allow-popups"
		Cross-Origin-Embedder-Policy "credentialless"
	}

	handle /env.js {
		header Content-Type "text/javascript"
		respond `window.config = {"VITE_USER_POOLS_WEB_CLIENT_ID":"{$VITE_USER_POOLS_WEB_CLIENT_ID}","VITE_USER_POOLS_ID":"{$VITE_USER_POOLS_ID}","VITE_ZONE":"{$VITE_ZONE}"};`
	}

	# Proxy backend API requests to internal backend service
	handle /api/* {
		reverse_proxy {$BACKEND_SERVICE_URL} {
			header_up X-Forwarded-By "caddy-proxy"
		}
	}

	# Proxy health endpoint to internal backend service
	handle /health {
		reverse_proxy {$BACKEND_SERVICE_URL} {
			header_up X-Forwarded-By "caddy-proxy"
		}
	}

	handle_path /* {
		try_files {path} {path}/ {file} /index.html?
	}

	@html path /index.html
	handle @html {
		templates
		replace __APP_CONFIG__ `{\"VITE_USER_POOLS_WEB_CLIENT_ID\":\"{$VITE_USER_POOLS_WEB_CLIENT_ID}\",\"VITE_USER_POOLS_ID\":\"{$VITE_USER_POOLS_ID}\",\"VITE_ZONE\":\"{$VITE_ZONE}\",\"VITE_BACKEND_URL\":\"{$VITE_BACKEND_URL}\"}`
	}

	file_server
}
