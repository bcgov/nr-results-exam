{
	auto_https off
	admin off
}

:3000 {
	root * /srv

	encode gzip

	log {
		output stdout
		format console {
			time_format iso8601
			level_format color
		}
		level {$LOG_LEVEL}
	}

	# Redirect from URL format to main URL format
	# Only redirect URLs that match *.apps.silver.devops.gov.bc.ca but don't contain "-frontend"
	# This ensures main URLs (with -frontend) are never redirected
	@redirect_from_host {
		header Host *.apps.silver.devops.gov.bc.ca
		not header Host *-frontend.apps.silver.devops.gov.bc.ca
	}
	handle @redirect_from_host {
		redir {env.REDIRECT_TO_URL} permanent
	}

	header {
		# Security headers
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1;mode=block"
		Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate"
		X-Content-Type-Options "nosniff"
		Strict-Transport-Security "max-age=31536000"
		# Content Security Policy - strict policy with no unsafe directives
		Content-Security-Policy "base-uri 'self';
			connect-src 'self' {$VITE_BACKEND_URL} https://*.gov.bc.ca https://*.amazoncognito.com https://*.cloudfront.net https://cognito-idp.ca-central-1.amazonaws.com;
			default-src 'self';
			font-src 'self';
			form-action 'self';
			frame-ancestors 'self';
			frame-src 'self' https://*.gov.bc.ca;
			img-src 'self' data: http://www.w3.org/;
			manifest-src 'self';
			media-src 'self';
			object-src 'none';
			script-src 'self';
			style-src 'self';
			worker-src 'none';"
		Referrer-Policy "same-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), autoplay=(), encrypted-media=(), picture-in-picture=()"
		Cross-Origin-Opener-Policy "same-origin-allow-popups"
		Cross-Origin-Embedder-Policy "credentialless"
	}

	# Proxy backend API requests to internal backend service
	handle /api/* {
		reverse_proxy {$BACKEND_SERVICE_URL} {
			header_up X-Forwarded-By "caddy-proxy"
		}
	}

	# Proxy health endpoint to internal backend service
	handle /health {
		reverse_proxy {$BACKEND_SERVICE_URL} {
			header_up X-Forwarded-By "caddy-proxy"
		}
	}

	# Rewrite SPA routes to index.html so we can inject runtime config via templates
	@spa {
		not path /api/*
		not path /health
		not file
	}

	rewrite @spa /index.html

	# Process templates only for index.html to inject runtime config
	@html {
		path /index.html
	}

	handle @html {
		templates
		file_server
	}

	file_server
}
